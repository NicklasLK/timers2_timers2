{% extends "base.html" %}

{% block content %}
    <form method="POST">
        {{ form.csrf_token }}
        <div class="mb-3">
            {{ form.start_time.label(class="form-label") }}
            {{ form.start_time(class="form-control"
                                     if not form.start_time.errors
                                     else "form-control is-invalid",
                               onchange="startTimeParse();") }}
            <div class="form-text">
                Format: 1d 2h 3m 4s or copy/paste from selected items window
            </div>
            {{ form.start_time|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.system.label(class="form-label") }}
            {{ form.system(class="form-control"
                                 if not form.system.errors
                                 else "form-control is-invalid") }}
            {{ form.system|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.corporation_ticker.label(class="form-label") }}
            {{ form.corporation_ticker(class="form-control"
                                             if not form.corporation_ticker.errors
                                             else "form-control is-invalid") }}
            {{ form.corporation_ticker|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.alliance_ticker.label(class="form-label") }}
            {{ form.alliance_ticker(class="form-control") }}
        </div>
        <div class="mb-3">
            {{ form.standing_type.label(class="form-label") }}
            {{ form.standing_type(class="form-control"
                                        if not form.standing_type.errors
                                        else "form-control is-invalid") }}
            {{ form.standing_type|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.structure_type.label(class="form-label") }}
            {{ form.structure_type(class="form-control"
                                         if not form.structure_type.errors
                                         else "form-control is-invalid") }}
            {{ form.structure_type|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.timer_type.label(class="form-label") }}
            {{ form.timer_type(class="form-control"
                                     if not form.timer_type.errors
                                     else "form-control is-invalid") }}
            {{ form.timer_type|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.replace.label(class="form-label") }}
            {{ form.replace(class="form-control"
                                  if not form.replace.errors
                                  else "form-control is-invalid") }}
            {{ form.replace|field_errors }}
        </div>
        <div class="mb-3">
            {{ form.notes.label(class="form-label") }}
            {{ form.notes(class="form-control") }}
        </div>

        <input type="submit" class="btn btn-primary" value="Save"/>
    </form>
{% endblock %}

{% block scripts %}
    <script>
        function startTimeParse() {
            const startTimeField = document.querySelector("#start_time");
            const text = startTimeField?.value?.trim();

            // Fast guard
            if (!text || !/reinforced\s+until/i.test(text)) {
                return;
            }

            // Example texts:
            // Orbital Skyhook (3T7-M I) [Sappo's Shuttle Gas] 1,234 m Reinforced Until 2069.04.20 13:37:00
            // 3T7-M - Catboy Milking Farm 42,069 km Reinforced until 2069.04.20 13:37:00
            //
            // Capture groups:
            //   1 = structure type (if present)
            //   2 = system name
            //   3 = date string
            const re = /^\s*(?:(?<structure>.*?)\s*\(\s*(?<system1>[^\s)]+)[^)]*\)|(?<system2>[A-Za-z0-9-]+))(?:\s*-\s*.*)?\s*.*?Reinforced\s+Until\s+(?<date>.+)$/i;
            const m = re.exec(text);
            if (!m || !m.groups) {
                return;
            }

            const structureType = (m.groups.structure ?? "").trim();
            const systemName = (m.groups.system1 ?? m.groups.system2 ?? "").trim();
            const dateStr = m.groups.date.trim();

            // Fill text fields if empty
            const systemField = document.querySelector("#system");
            const notesField = document.querySelector("#notes");
            if (systemName && systemField && !systemField.value) {
                systemField.value = systemName;
            }
            if (structureType && notesField && !notesField.value) {
                notesField.value = structureType;
            }

            // Set structure_type select
            const structureSelect = document.querySelector("#structure_type");
            if (structureType && structureSelect) {
                const lowerTarget = structureType.toLowerCase();
                const options = Array.from(structureSelect.options);

                // Find option whose display text matches (case-insensitive)
                const match = options.find(
                    (opt) => opt.text.trim().toLowerCase() === lowerTarget
                );

                // Select match or fallback
                structureSelect.value = match?.value ?? "OTHER_UNKNOWN";

                // Trigger a 'change' event
                structureSelect.dispatchEvent(new Event("change", { bubbles: true }));
            }

            return { structureType, systemName, dateStr };
        }
    </script>
{% endblock %}
